<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BUDS LAB – Tag Engine Playground</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #050505;
      color: #f5f5f5;
    }
    .app-header {
      background: #ff7a00;
      color: #050505;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 4px rgba(0,0,0,0.4);
    }
    .app-title {
      font-size: 18px;
      font-weight: 600;
    }
    .app-sub {
      font-size: 12px;
      opacity: 0.8;
    }
    .app-link {
      font-size: 12px;
      text-decoration: none;
      color: #050505;
      background: rgba(0,0,0,0.08);
      padding: 4px 8px;
      border-radius: 999px;
    }
    .layout {
      display: flex;
      gap: 16px;
      padding: 16px;
    }
    .panel {
      flex: 1;
      background: #111;
      border-radius: 10px;
      border: 1px solid #222;
      padding: 12px;
      display: flex;
      flex-direction: column;
      min-height: 420px;
    }
    .panel-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .panel-subtitle {
      font-size: 12px;
      opacity: 0.7;
    }
    .row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }
    label {
      font-size: 12px;
      opacity: 0.85;
    }
    input[type="text"], select, textarea {
      flex: 1;
      background: #050505;
      color: #f5f5f5;
      border-radius: 6px;
      border: 1px solid #333;
      font-size: 12px;
      padding: 4px 6px;
      outline: none;
    }
    textarea {
      min-height: 160px;
      resize: vertical;
    }
    .btn {
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #444;
      background: #222;
      color: #f5f5f5;
      cursor: pointer;
    }
    .btn:hover {
      background: #333;
    }
    .btn-primary {
      background: #ff7a00;
      color: #050505;
      border-color: #ff7a00;
    }
    .btn-primary:hover {
      background: #ffa333;
    }
    .btn-pill {
      font-size: 11px;
      padding: 3px 10px;
      border-radius: 999px;
      border: 1px solid #444;
      background: #111;
      cursor: pointer;
      margin-left: 4px;
    }
    .btn-pill-active {
      background: #ff7a00;
      color: #050505;
      border-color: #ff7a00;
    }
    .btn-pill-inactive {
      background: #111;
      color: #ccc;
    }
    .btn-small {
      font-size: 10px;
      padding: 2px 8px;
    }
    .tx-section {
      border-radius: 8px;
      border: 1px solid #222;
      padding: 6px;
      margin-bottom: 6px;
      background: #0c0c0c;
    }
    .tag-list {
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      white-space: pre-wrap;
      background: #050505;
      border-radius: 6px;
      border: 1px solid #222;
      padding: 6px;
      margin-top: 4px;
      flex: 1;
      overflow: auto;
    }
    .small-text {
      font-size: 11px;
      opacity: 0.8;
    }
    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid #333;
      font-size: 10px;
      margin: 2px 2px 2px 0;
      background: #181818;
    }
    .footer-note {
      font-size: 10px;
      opacity: 0.7;
      padding: 0 16px 8px;
    }

    /* Summary & ARBDA styling */
    .summary-box {
      font-size: 12px;
      line-height: 1.4;
    }
    .summary-card {
      background: #050505;
      border-radius: 8px;
      border: 1px solid #333;
      padding: 6px 8px;
      margin-top: 6px;
    }
    .summary-heading {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .arbda-card {
      background: #050505;
      border-radius: 10px;
      border: 1px solid #333;
      padding: 8px 10px;
      margin-top: 8px;
    }
    .arbda-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      opacity: 0.8;
    }
    .arbda-value {
      font-size: 24px;
      font-weight: 700;
      margin-top: 4px;
    }
    .arbda-desc {
      font-size: 11px;
      opacity: 0.85;
      margin-top: 2px;
    }
    .arbda-t0 .arbda-value { color: #33c3ff; }  /* blue */
    .arbda-t1 .arbda-value { color: #4caf50; }  /* green */
    .arbda-t2 .arbda-value { color: #ffc107; }  /* yellow */
    .arbda-t3 .arbda-value { color: #ff5252; }  /* red */

    /* Tier legend chips */
    .tier-legend {
      margin-top: 4px;
    }
    .tier-chip {
      display: inline-block;
      padding: 1px 6px;
      border-radius: 999px;
      border: 1px solid #333;
      font-size: 10px;
      margin-right: 4px;
      margin-bottom: 2px;
    }
    .tier-chip.t0 { color: #33c3ff; border-color: #33c3ff33; }
    .tier-chip.t1 { color: #4caf50; border-color: #4caf5033; }
    .tier-chip.t2 { color: #ffc107; border-color: #ffc10733; }
    .tier-chip.t3 { color: #ff5252; border-color: #ff525233; }

    /* Tier tag for breakdown ( (T1) etc ) */
    .tier-tag {
      font-weight: 600;
    }
    .tier-tag.t0 { color: #33c3ff; }
    .tier-tag.t1 { color: #4caf50; }
    .tier-tag.t2 { color: #ffc107; }
    .tier-tag.t3 { color: #ff5252; }

    @media (max-width: 960px) {
      .layout {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="app-header">
    <div>
      <div class="app-title">BUDS LAB</div>
      <div class="app-sub">Bitcoin Unified Data Standard – Tag Engine Playground</div>
    </div>
    <div>
      <a class="app-link" href="https://github.com/defenwycke/bitcoin-unified-data-standard/blob/main/docs/buds-lab.md" target="_blank">
        Docs &amp; README
      </a>
    </div>
  </div>

  <div class="layout">
    <!-- Left panel: transaction input -->
    <div class="panel">
      <div class="panel-title">
        <span>Transaction Input</span>
        <span>
          <button id="modeBuilderBtn" class="btn-pill btn-pill-active" onclick="setInputMode('builder')">Builder</button>
          <button id="modeJsonBtn" class="btn-pill btn-pill-inactive" onclick="setInputMode('json')">JSON</button>
        </span>
      </div>

      <!-- Builder mode -->
      <div id="builderMode">
        <div class="row">
          <label style="flex:0 0 80px;">TXID</label>
          <input type="text" id="txid" placeholder="deadbeef..." />
        </div>

        <div class="panel-subtitle" style="margin-top:6px;">Outputs (scriptPubKey)</div>
        <div id="outputs"></div>
        <div class="row">
          <button class="btn" onclick="addOutput()">+ Add output</button>
        </div>

        <div class="panel-subtitle" style="margin-top:6px;">Witness (stack items)</div>
        <div id="witness"></div>
        <div class="row">
          <button class="btn" onclick="addWitnessItem()">+ Add witness item</button>
        </div>
      </div>

      <!-- JSON mode -->
      <div id="jsonMode" style="display:none;">
        <div class="panel-subtitle" style="margin-bottom:4px;">
          Paste a SimpleTx-style JSON object:
        </div>
        <textarea id="jsonInput" placeholder='{"txid":"...","vout":[...],"witness":[...]}'></textarea>
      </div>

      <div class="row" style="margin-top:8px; justify-content:space-between;">
        <div>
          <button class="btn" onclick="loadExampleTx()">Load example</button>
          <button class="btn" onclick="clearTx()">Clear</button>
        </div>
        <div>
          <button class="btn" onclick="exportJson()">Export JSON</button>
          <button class="btn btn-primary" onclick="runTagEngine()">Run Tag Engine</button>
        </div>
      </div>
    </div>

    <!-- Right panel: policy + output -->
    <div class="panel">
      <div class="panel-title">
        <span>Node Policy & Fees (example)</span>
      </div>

      <div class="row">
        <label style="flex:0 0 130px;">Base mempool min (sat/vB)</label>
        <input type="text" id="baseMinFeerate" value="1.0" />
      </div>
      <div class="row">
        <label style="flex:0 0 130px;">Tx feerate (sat/vB)</label>
        <input type="text" id="txFeerate" value="5.0" />
      </div>
      <div class="row">
        <label style="flex:0 0 130px;">Policy profile</label>
        <select id="policyProfile">
          <option value="neutral" selected>neutral</option>
          <option value="strict">strict</option>
          <option value="permissive">permissive</option>
        </select>
      </div>

      <!-- ARBDA SCORE CARD -->
      <div id="arbdaScoreCard" class="arbda-card">
        <div class="arbda-label">ARBDA score</div>
        <div id="arbdaScoreValue" class="arbda-value">–</div>
        <div id="arbdaScoreDesc" class="arbda-desc">
          Run the Tag Engine to see the worst-tier ARBDA classification for this transaction.
        </div>
      </div>

      <!-- Summary -->
      <div id="summary" style="margin-top:8px;" class="summary-box">
        No classification yet. Build or paste a transaction and run the Tag Engine.
      </div>

      <!-- Breakdown -->
      <div class="panel-subtitle" style="margin-top:8px;">Output / Region breakdown</div>
      <div id="breakdownList" class="tag-list" style="margin-bottom:6px;">
No breakdown yet. Run the Tag Engine to see per-output labels and tiers.
      </div>

      <!-- Raw tag list -->
      <div class="panel-subtitle" style="margin-top:4px;">Raw tags</div>
      <div id="tagList" class="tag-list">
No tags yet. Build or paste a transaction and click "Run Tag Engine".
      </div>
    </div>
  </div>

  <div class="footer-note">
    Tag Engine: OP_RETURN / P2PKH / witness blob-size heuristic. Non-consensus, reference only.
  </div>

  <script src="buds-tag-engine.js"></script>
  <script>
    let currentInputMode = "builder";
    let lastResult = null;

    function setInputMode(mode) {
      currentInputMode = mode;

      const builder = document.getElementById("builderMode");
      const json = document.getElementById("jsonMode");
      const builderBtn = document.getElementById("modeBuilderBtn");
      const jsonBtn = document.getElementById("modeJsonBtn");

      if (mode === "builder") {
        builder.style.display = "";
        json.style.display = "none";
        builderBtn.className = "btn-pill btn-pill-active";
        jsonBtn.className = "btn-pill btn-pill-inactive";
      } else {
        builder.style.display = "none";
        json.style.display = "";
        builderBtn.className = "btn-pill btn-pill-inactive";
        jsonBtn.className = "btn-pill btn-pill-active";
      }
    }

    function reindexOutputs() {
      const sections = document.querySelectorAll("#outputs > .tx-section");
      sections.forEach((wrapper, idx) => {
        const label = wrapper.querySelector('label[data-role="output-label"]');
        if (label) label.textContent = `Output #${idx}`;
      });
    }

    function reindexWitness() {
      const rows = document.querySelectorAll("#witness > .row");
      rows.forEach((wrapper, idx) => {
        const label = wrapper.querySelector('label[data-role="witness-label"]');
        if (label) label.textContent = `Item #${idx}`;
      });
    }

    function addOutput(type = "custom", spkAsm = "", spkHex = "") {
      const container = document.getElementById("outputs");
      const idx = container.children.length;

      const wrapper = document.createElement("div");
      wrapper.className = "tx-section";
      wrapper.style.margin = "4px 0";
      wrapper.innerHTML = `
        <div class="row">
          <label data-role="output-label" style="flex:0 0 80px;">Output #${idx}</label>
          <select data-type="spk-type">
            <option value="custom">Custom</option>
            <option value="p2pkh">P2PKH</option>
            <option value="p2wpkh">P2WPKH</option>
            <option value="p2tr">P2TR</option>
            <option value="opreturn">OP_RETURN</option>
          </select>
          <button type="button" class="btn btn-small" data-action="remove-output">Remove</button>
        </div>
        <div class="row">
          <label style="flex:0 0 80px;">ASM</label>
          <input type="text" data-field="asm" placeholder="e.g. OP_DUP OP_HASH160 ..." />
        </div>
        <div class="row">
          <label style="flex:0 0 80px;">Hex</label>
          <input type="text" data-field="hex" placeholder="raw scriptPubKey hex" />
        </div>
      `;
      container.appendChild(wrapper);

      const typeSelect = wrapper.querySelector('select[data-type="spk-type"]');
      const asmInput = wrapper.querySelector('input[data-field="asm"]');
      const hexInput = wrapper.querySelector('input[data-field="hex"]');
      const removeBtn = wrapper.querySelector('button[data-action="remove-output"]');

      function applyTemplate(t) {
        if (t === "p2pkh") {
          asmInput.value = "OP_DUP OP_HASH160 <pubkeyhash> OP_EQUALVERIFY OP_CHECKSIG";
          hexInput.value = "76a91400112233445566778899aabbccddeeff0011223388ac";
        } else if (t === "p2wpkh") {
          asmInput.value = "0 <20-byte-pubkeyhash>";
          hexInput.value = "001400112233445566778899aabbccddeeff00112233";
        } else if (t === "p2tr") {
          asmInput.value = "1 <32-byte-xonly-pubkey>";
          hexInput.value = "5120" + "11".repeat(32);
        } else if (t === "opreturn") {
          asmInput.value = "OP_RETURN 6f6b";
          hexInput.value = "6a026f6b";
        } else {
          if (!spkAsm && !spkHex) {
            asmInput.value = "";
            hexInput.value = "";
          }
          return;
        }
      }

      typeSelect.value = type;
      if (spkAsm || spkHex) {
        asmInput.value = spkAsm;
        hexInput.value = spkHex;
      } else {
        applyTemplate(type);
      }

      typeSelect.addEventListener("change", () => {
        applyTemplate(typeSelect.value);
      });

      removeBtn.addEventListener("click", () => {
        wrapper.remove();
        reindexOutputs();
      });

      reindexOutputs();
    }

    function addWitnessItem(hex = "") {
      const container = document.getElementById("witness");
      const idx = container.children.length;

      const wrapper = document.createElement("div");
      wrapper.className = "row";
      wrapper.innerHTML = `
        <label data-role="witness-label" style="flex:0 0 80px;">Item #${idx}</label>
        <input type="text" data-field="witness-hex" placeholder="hex-encoded witness item" value="${hex}" />
        <button type="button" class="btn btn-small" data-action="remove-witness">Remove</button>
      `;
      container.appendChild(wrapper);

      const removeBtn = wrapper.querySelector('[data-action="remove-witness"]');
      removeBtn.addEventListener("click", () => {
        wrapper.remove();
        reindexWitness();
      });

      reindexWitness();
    }

    function clearTx() {
      document.getElementById("txid").value = "";
      document.getElementById("outputs").innerHTML = "";
      document.getElementById("witness").innerHTML = "";
      document.getElementById("jsonInput").value = "";
      document.getElementById("tagList").textContent =
        'No tags yet. Build or paste a transaction and click "Run Tag Engine".';
      document.getElementById("breakdownList").textContent =
        'No breakdown yet. Run the Tag Engine to see per-output labels and tiers.';
      document.getElementById("summary").innerHTML =
        "No classification yet. Build or paste a transaction and run the Tag Engine.";
      const card = document.getElementById("arbdaScoreCard");
      card.classList.remove("arbda-t0", "arbda-t1", "arbda-t2", "arbda-t3");
      document.getElementById("arbdaScoreValue").textContent = "–";
      document.getElementById("arbdaScoreDesc").textContent =
        "Run the Tag Engine to see the worst-tier ARBDA classification for this transaction.";
      lastResult = null;
    }

    function loadExampleTx() {
      if (currentInputMode === "json") {
        const example = {
          txid: "deadbeefcafebabe0011223344556677",
          vout: [
            {
              scriptPubKey: {
                asm: "OP_DUP OP_HASH160 <pubkeyhash> OP_EQUALVERIFY OP_CHECKSIG",
                hex: "76a91400112233445566778899aabbccddeeff0011223388ac"
              }
            },
            {
              scriptPubKey: {
                asm: "OP_RETURN 6f6b",
                hex: "6a026f6b"
              }
            }
          ],
          witness: [
            {
              stack: ["00".repeat(600)]
            }
          ]
        };
        document.getElementById("jsonInput").value = JSON.stringify(example, null, 2);
        return;
      }

      clearTx();
      document.getElementById("txid").value = "deadbeefcafebabe0011223344556677";
      addOutput("p2pkh");
      addOutput("opreturn");
      let bigHex = "";
      for (let i = 0; i < 600; i++) bigHex += "00";
      addWitnessItem(bigHex);
    }

    function buildTxFromBuilder() {
      const txid = document.getElementById("txid").value || "<no-txid>";

      const outputs = [];
      document.querySelectorAll("#outputs > .tx-section").forEach(wrapper => {
        const asm = wrapper.querySelector('input[data-field="asm"]').value.trim();
        const hex = wrapper.querySelector('input[data-field="hex"]').value.trim();
        if (asm || hex) {
          outputs.push({ scriptPubKey: { asm, hex } });
        }
      });

      const witness = [];
      const witItems = [];
      document.querySelectorAll('input[data-field="witness-hex"]').forEach(input => {
        const hex = input.value.trim();
        if (hex.length > 0) witItems.push(hex);
      });
      if (witItems.length > 0) {
        witness.push({ stack: witItems });
      }

      return { txid, vout: outputs, witness };
    }

    function buildTxFromJson() {
      const raw = document.getElementById("jsonInput").value.trim();
      if (!raw) {
        alert("Paste a JSON transaction first.");
        return null;
      }
      try {
        const obj = JSON.parse(raw);
        return obj;
      } catch (e) {
        alert("Failed to parse JSON: " + e.message);
        return null;
      }
    }

    function runTagEngine() {
      let tx;
      if (currentInputMode === "builder") {
        tx = buildTxFromBuilder();
      } else {
        tx = buildTxFromJson();
        if (!tx) return;
      }

      const baseMin = parseFloat(document.getElementById("baseMinFeerate").value) || 1.0;
      const txFeerate = parseFloat(document.getElementById("txFeerate").value) || 5.0;
      const profile = document.getElementById("policyProfile").value || "neutral";

      const engine = new BudsTagEngine(profile);
      const classification = engine.classify(tx);
      const tiers = engine.summarizeTiers(classification);
      const arbdaTier = engine.computeArbdaTierFromCounts(tiers.counts);
      const policy = engine.computePolicy(classification, baseMin, txFeerate);

      lastResult = { tx, classification, tiers, policy, profile, arbdaTier };

      // Raw tags
      const tagLines = classification.tags.map(tag => {
        const labelsStr = tag.labels.join(",");
        return `surface=${tag.surface}  range=[${tag.start},${tag.end})  labels=[${labelsStr}]`;
      });
      document.getElementById("tagList").textContent =
        tagLines.length ? tagLines.join("\n") : "No tags produced.";

      // Breakdown with coloured (T#)
      const breakdownLines = [];
      (classification.tags || []).forEach(tag => {
        const labels = tag.labels.join(", ");
        let region = tag.surface;
        if (tag.surface.startsWith("scriptpubkey[")) {
          const m = tag.surface.match(/scriptpubkey\[(\d+)\]/);
          if (m) region = `Output #${m[1]}`;
        } else if (tag.surface.startsWith("witness.stack[")) {
          const m = tag.surface.match(/witness\.stack\[(\d+):(\d+)\]/);
          if (m) region = `Witness[${m[1]}:${m[2]}]`;
        }
        let tier = "T3";
        if (tag.labels && tag.labels.length > 0) {
          tier = engine.getTierForLabel(tag.labels[0]);
        }
        const tierClass = tier.toLowerCase();
        breakdownLines.push(
          `${region} \u2192 ${labels} (` +
          `<span class="tier-tag ${tierClass}">${tier}</span>` +
          `)`
        );
      });
      document.getElementById("breakdownList").innerHTML =
        breakdownLines.length ? breakdownLines.join("<br>") :
        "No breakdown yet. Run the Tag Engine to see per-output labels and tiers.";

      // Classification summary + policy
      const allLabels = new Set();
      classification.tags.forEach(t => t.labels.forEach(l => allLabels.add(l)));
      let labelsHtml = "";
      allLabels.forEach(label => {
        labelsHtml += `<span class="badge">${label}</span>`;
      });

      const tiersStr = tiers.tiersPresent.length ? tiers.tiersPresent.join(", ") : "none";

      const tiersLegend = `
        <span class="tier-chip t0">T0 = consensus</span>
        <span class="tier-chip t1">T1 = economic</span>
        <span class="tier-chip t2">T2 = metadata</span>
        <span class="tier-chip t3">T3 = unknown/obfuscated</span>
      `;

      const summaryHtml = `
        <div class="summary-card">
          <div class="summary-heading">Classification summary</div>
          <div style="margin-bottom:4px;">${labelsHtml || "<em>No labels</em>"}</div>
          <div class="small-text">Triage tiers present: ${tiersStr}</div>
          <div class="tier-legend">
            ${tiersLegend}
          </div>
        </div>
        <div class="summary-card">
          <div class="summary-heading">Example policy (profile: <strong>${profile}</strong>)</div>
          <div class="tag-list" style="margin-top:4px;">
base mempool min : ${baseMin.toFixed(2)} sat/vB
tx feerate       : ${txFeerate.toFixed(2)} sat/vB
min multiplier   : ${policy.mult.toFixed(2)}x
required feerate : ${policy.required.toFixed(2)} sat/vB
effective score  : ${policy.score.toFixed(2)} (scaled sat/vB)
          </div>
        </div>
      `;
      document.getElementById("summary").innerHTML = summaryHtml;

      // ARBDA card
      const card = document.getElementById("arbdaScoreCard");
      card.classList.remove("arbda-t0", "arbda-t1", "arbda-t2", "arbda-t3");
      card.classList.add("arbda-" + arbdaTier.toLowerCase());
      document.getElementById("arbdaScoreValue").textContent = arbdaTier;

      let desc;
      if (arbdaTier === "T3") {
        desc = "Contains unknown or obfuscated data; ARBDA treats this as worst-case.";
      } else if (arbdaTier === "T2") {
        desc = "Contains metadata / OP_RETURN-style data but no T3 regions.";
      } else if (arbdaTier === "T1") {
        desc = "Economic/payment-style data only (no T2/T3 regions).";
      } else {
        desc = "Consensus-only / purely structural data.";
      }
      document.getElementById("arbdaScoreDesc").textContent = desc;
    }

    function exportJson() {
      if (!lastResult) {
        alert("Run the Tag Engine first before exporting.");
        return;
      }
      const out = JSON.stringify(lastResult, null, 2);

      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(out)
          .then(() => alert("BUDS LAB result copied to clipboard as JSON."))
          .catch(() => {
            window.prompt("Copy JSON:", out);
          });
      } else {
        window.prompt("Copy JSON:", out);
      }
    }

    // init
    setInputMode("builder");
    clearTx();
    document.getElementById("txid").value = "deadbeefcafebabe0011223344556677";
    addOutput("p2pkh");
    addOutput("opreturn");
    let bigHex = "";
    for (let i = 0; i < 600; i++) bigHex += "00";
    addWitnessItem(bigHex);
  </script>
</body>
</html>
